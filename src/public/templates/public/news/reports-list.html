{% extends "public/ads/base.html" %}
{% load staticfiles %}
{% load angular %}


{# Marking this safe because is not not rendered by django but added as a data attribute and rendered by Angular as unsafe #}
{% block bootstrap_data %}{{bootstrap_data|ng_mark_safe}}{% endblock %}

{% block main %}
<div class="dmb-reports-admin" dmb-reports-admin ng-cloak>
  <section class="dmb-u-grey-bg dmb-u-p-t-m dmb-u-p-b-m">
    <div class="h-c-page">
      <div class="h-c-eyebrow">
        {{ tenant|ng_mark_safe }}
      </div>
      <!-- TODO(aabuelgasim): Remove `dmb-u-m-b-s` class from elements with `h-c-headline` class (since it's built into `h-c-headline` in the new styles) once this ticket is merged https://gitlab.com/potato/google/digital-maturity-benchmark/dmb-publishers/issues/339 -->
      <h1 class="h-c-headline h-c-headline--two h-u-font-weight-medium dmb-u-m-b-s">
        {% if tenant|ng_mark_safe == 'ads' %}Digital {% else %}Data {% endif %}
        Maturity Admin Dashboard
      </h1>

      <div class="h-c-grid">
        <div class="dmb-reports-admin__card dmb-card h-c-grid__col h-c-grid__col-l--8">
          <h2 class="h-c-headline h-c-headline--three dmb-u-m-b-s">
            {% include 'core/inc/svg.html' with id='clipboard' inline=True %}Create survey
          </h2>
          <h3 class="h-c-headline h-c-headline--subhead h-u-font-weight-medium dmb-u-m-b-s">
            You can create a new survey in two ways:
          </h3>
          <div class="dmb-reports-admin__create-survey">
            <div class="dmb-reports-admin__create-survey-step">
              <h4 class="h-c-headline h-c-headline--subhead h-u-font-weight-medium dmb-u-m-b-xs">
                Create a custom survey
              </h4>
              <p class="dmb-u-m-b-s">
                Create a custom survey for your client using the button below. You’ll be able to set the company name, industry and location.
              </p>
              <button
                  class="dmb-right-panel-trigger h-c-button h-c-button--primary"
                  dmb-side-panel-trigger="#dmb-create-survey">
                Create a new survey
              </button>
            </div>
            <div class="dmb-reports-admin__create-survey-step">
              <h4 class="h-c-headline h-c-headline--subhead h-u-font-weight-medium dmb-u-m-b-xs">
                Send a referral link
              </h4>
              <p class="dmb-u-m-b-s">
                Send your survey referral link to allow clients to create their own unique survey. Any surveys created with this link will be associated with your account.
              </p>

              {% with url=create_survey_url|ng_mark_safe el=engagement_lead|ng_mark_safe %}
                {% include 'public/inc/global/copy-comp.inc.html' with id="referral-link" value=url|add:"#el="|add:el %}
              {% endwith %}

            </div>
          </div>
        </div>

        <div class="dmb-reports-admin__export dmb-reports-admin__card dmb-card h-c-grid__col h-c-grid__col-l--4">
          <h2 class="h-c-headline h-c-headline--three dmb-u-m-b-s">
            {% include 'core/inc/svg.html' with id='export' inline=True %}Export
          </h2>
          <h3 class="h-c-headline h-c-headline--subhead h-u-font-weight-medium dmb-u-m-b-s">
            Export the data from all your surveys
          </h3>
          <p class="dmb-u-m-b-s">
            Your data will be saved as a Google Sheet. <strong>Check your inbox</strong> for a link. This may take up to 5 minutes.
          </p>
          <div
              class="dmb-reports-admin__export-actions h-u-text-center"
              ng-controller="ExportReportsCtrl as exportsCtrl">

            <form
                action="{% url 'reports_export' slug|ng_mark_safe %}"
                method="post"
                name="export"
                ng-if="!exportsCtrl.exportSuccess && !exportsCtrl.exportError"
                ng-submit="exportsCtrl.export($event, '{{engagement_lead|ng_mark_safe}}')"
                novalidate>
              <button
                  class="h-c-button h-c-button--primary"
                  id="dmb-export-btn"
                  type="submit">
                Export data
              </button>
            </form>

            <div
                class="dmb-reports-admin__export-sucess"
                ng-if="exportsCtrl.exportSuccess">
              {% include 'core/inc/svg.html' with id='success' size='46px' only %}
              <h3 class="h-c-headline h-c-headline--subhead h-u-font-weight-medium dmb-u-m-b-xs">
                Export sent
              </h3>
              <p class="h-c-footnote h-u-font-weight-medium">
                If you don’t receive an email within 5 minutes
                <a
                    class="h-c-button h-c-button--flat h-c-footnote h-u-font-weight-medium"
                    ng-click="exportsCtrl.resetExport()">
                      try again
                </a>
              </p>
            </div>

            <div
                class="dmb-reports-admin__export-error"
                ng-if="exportsCtrl.exportError">
              {% include 'core/inc/svg.html' with id='error' size='46px' only %}
              <h3 class="h-c-headline h-c-headline--subhead h-u-font-weight-medium dmb-u-m-b-xs">
                Export error
              </h3>
              <p class="h-c-footnote h-u-font-weight-medium">
                Sorry there was an error please
                <button
                    class="h-c-button h-c-button--flat h-c-footnote h-u-font-weight-medium"
                    ng-click="exportsCtrl.resetExport()">
                      try again
                </button>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div
      dmb-side-panel
      class="dmb-side-panel dmb-side-panel--narrow dmb-side-panel--right"
      id="dmb-create-survey">
    <button class="dmb-side-panel__fab dmb-fab" dmb-side-panel-close>
      <span class="dmb-fab__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <use xlink:href="#mi-close"></use>
        </svg>
      </span>
    </button>

    <div
        class="dmb-side-panel__inner"
        ng-controller="RegistrationCtrl as registrationCtrl">
      <div ng-if="!registrationCtrl.link">
        <h2 class="h-c-headline h-c-headline--three h-u-mt-xl h-u-mb-l">
          Create a new survey
        </h2>
        <p>
            Fill in these details to create a custom survey link for a specific company:
        </p>
        <form name="registration" novalidate autocomplete="off" ng-submit="registrationCtrl.submit()" ng-init="registrationCtrl.engagementLead='{{engagement_lead|ng_mark_safe}}'">
          <div class="input-wrp">
            <div class="dmb-input-wrp">
              <input class="dmb-input" id="tenant" name="tenant" ng-model="registrationCtrl.tenant" type="hidden" required value="{{tenant|ng_mark_safe}}" ng-init="registrationCtrl.tenant='{{tenant|ng_mark_safe}}'">
            </div>
            <div class="dmb-input-wrp">
              <label for="companyName">Organization name:</label>
              <input class="dmb-input" name="companyName" ng-model="registrationCtrl.companyName" type="text" required placeholder="Enter the organization name">
            </div>
            <div class="dmb-input-wrp">
              {% comment %} TODO: use news industry here {% endcomment %}
              <input id="prodId" name="industry" type="hidden" value="ic-bnpj" ng-init="registrationCtrl.industry='ic-bnpj'">
            </div>
            <div class="dmb-input-wrp">
              <label for="country">Country:</label>
              <select class="dmb-input" name="country" id="country" ng-model="registrationCtrl.country" required>
                <option value="" disabled selected>Select a country</option>
                {% for c_key, c_text in countries %}
                <option value="{{c_key|ng_mark_safe}}">{{c_text|ng_mark_safe}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="input-wrp__error" ng-show="!registration.companyName.$pristine && registration.companyName.$error.required">This field is required.</div>
          </div>
          <button ng-disabled="!registration.$valid" class="h-c-button h-c-button--primary">
            Create assessment
          </button>
          <div class="input-wrp__error" ng-hide="!registrationCtrl.serverError">Oops, something went wrong!</div>
        </form>
      </div>
      <div ng-if="registrationCtrl.link">
        <h2 class="h-c-headline h-c-headline--three h-c-headline--three h-u-mt-xl h-u-mb-l">
          Unique survey created
        </h2>
        <p>
          Your custom survey link is below.
          Send this link to your client so that they can get started.
        </p>

        {% include 'public/inc/global/copy-comp.inc.html' with id="survey-link" value='{[ registrationCtrl.link ]}' %}

        <button class="h-c-button h-c-button--primary" ng-click="registrationCtrl.reset()">
          Create another assessment
        </button>
        <p class="h-c-footnote">
          Please reload the page to see the new survey in the list.
        </p>
      </div>
    </div>
  </div>

  <div class="dmb-reports-admin__table h-c-table__overflowcontainer">
    <table class="h-c-table h-c-table--datatable h-c-table--datatable-altrows glue-table-sort"
      data-glue-table-sort-ascending-text="ascending"
      data-glue-table-sort-descending-text="descending"
      data-glue-table-sort-unsorted-text="unsorted"
      role="table"
      summary="List of reports"
      width="100%"
    >
      <thead>
        <tr role="row">
          <th
              scope="col"
              role="columnheader"
              title="Sort by organization name alphabetically"
              data-glue-table-sort-type="alpha">
            <span>
              Organization name
            </span>
          </th>
            <th
              scope="col"
              role="columnheader"
              title="Sort by date created chronologically"
              data-glue-table-sort-type="datetime-custom">
            <span>
              Date created
            </span>
          </th>
          <th
          scope="col"
          role="columnheader"
          title="Sort by survey completions numerically"
          data-glue-table-sort-type="numeric">
          <span>
            Survey completions
          </span>
          <th
              scope="col"
              role="columnheader"
              title="Sort by survey link">
            <span>
              Survey link
            </span>
          </th>
          </th>
          <th
              scope="col"
              role="columnheader"
              title="Sort by report link"
              data-glue-table-sort-type="alpha">
            <span>
              Report link
            </span>
          </th>
          <th
              scope="col"
              role="columnheader"
              title="Sort by country"
              data-glue-table-sort-type="alpha">
            <span>
              Detail
            </span>
          </th>
          <th
              scope="col"
              role="columnheader"
              title="Sort by industry"
              class="dmb-reports-admin__industry-col"
              data-glue-table-sort-type="alpha">
            <span>
              Industry
            </span>
          </th>
          <th
              scope="col"
              role="columnheader"
              title="Sort by country"
              data-glue-table-sort-type="alpha">
            <span>
              Country
            </span>
         </th>
        </tr>
      </thead>
      <tbody>
        <tr
            role="row"
            ng-repeat="survey in reportAdminCtrl.surveys"
            data-index={[$index]}
            ng-class="{'dmb-reports-admin__table-expanded-row': reportAdminCtrl.expandedRows[$index]}"
        >
          <td role="rowheader" title="{[survey.company_name]}">{[survey.company_name]}</td>
          <td role="gridcell" ng-attr-title="{[survey.created_at|date:'d/M/yyyy hh:mm']}">
              {[survey.created_at|date:"d/M/yyyy"]}
              {% comment %} This is used by tablesort-utility.js module to sort by date, please update it if this changes {% endcomment %}
              <span class="dmb-reports-admin__table-date">utc={[survey.created_at]}</span>
          </td>
          <td role="gridcell">
            {[ survey.survey_results.length ]}
            <button
                class="dmb-reports-admin__table-history-btn"
                ng-if="survey.survey_results.length > 1"
                ng-click="reportAdminCtrl.viewHistory($index)"
              >
              View history
              <svg role="img" class="h-c-icon">
                <use xlink:href="#mi-chevron"></use>
              </svg>
            </button>
            <div
                class="dmb-reports-admin__table-subcell dmb-reports-admin__table-subcell--first"
                ng-repeat="r in survey.survey_results">
              {[r.started_at|date:"d/M/yyyy hh:mm"]}
            </div>
          </td>
          <td role="gridcell"><a href="{[survey.link]}" target="_blank" class="h-c-button h-c-button--flat">Survey</a></td>
          <td role="gridcell">
            <a
                class="h-c-button h-c-button--flat dmb-reports-admin__table-top-report-cell"
                ng-if="survey.survey_results.length > 0"
                ng-href="{[survey.last_survey_result_link]}"
                target="_blank">
              Report
            </a>&nbsp;
            <span
                ng-if="survey.survey_results.length == 0">
              -
            </span>
            <div
                class="dmb-reports-admin__table-subcell"
                ng-repeat="r in survey.survey_results">
              <a
                  class="h-c-button h-c-button--flat"
                  ng-href="{[r.report_link]}"
                  target="_blank">
                Report
              </a>
            </div>
          </td>
          <td role="gridcell">
            <a class="h-c-button h-c-button--flat dmb-reports-admin__table-top-report-cell" ng-if="survey.last_survey_result.detail_link"
              ng-href="{[survey.last_survey_result.detail_link]}" target="_blank">
              Detail
            </a>&nbsp;
            <span ng-if="!survey.last_survey_result.detail_link">
              -
            </span>
            <div class="dmb-reports-admin__table-subcell" ng-repeat="r in survey.survey_results">
              <a ng-if="r.detail_link" class="h-c-button h-c-button--flat" ng-href="{[r.detail_link]}" target="_blank">
                Detail
              </a>
              <span ng-if="!r.detail_link">
                -
              </span>
            </div>
          </td>
          <td role="gridcell" class="dmb-reports-admin__industry-col" ng-attr-title="{[survey.industry_name]}">{[survey.industry_name]}</td>
          <td role="gridcell">{[survey.country_name]}</td>
        </tr>
      </tbody>
    </table>
    <div class="glue-js-table__caption"></div>
  </div>
</div>
{% endblock %}
