{% extends 'public/base.html' %}
{% load staticfiles %}
{% load angular %}

{# Marking this safe because is not not rendered by django but added as a data attribute and rendered by Angular as unsafe #}
{% block bootstrap_data %}{{bootstrap_data|ng_mark_safe}}{% endblock %}

{% block main %}
<div id="dmb-admin-reports" dmb-reports-admin ng-cloak>
  <ul class="dmb-reports-admin__create-survey">
    <li>
      <h3 class="h-c-headline h-c-headline--five h-u-font-weight-medium">
        Create a custom Survey
      </h3>
      <p class="dmb-reports-admin__survey-creation-text">
        Create a custom survey for your client using the button below.<br>
        Youâ€™ll be able to set the company name, industry and location.
      </p>
      <button
          class="dmb-right-panel-trigger h-c-button h-c-button--primary"
          dmb-side-panel-trigger="#dmb-create-survey">
        Create new survey
      </button>
    </li>
    <li class="dmb-reports-admin__referral-wrp">
      <h3 class="h-c-headline h-c-headline--five h-u-font-weight-medium">
        Send a referral link
      </h3>
      <p class="dmb-reports-admin__survey-creation-text">
        Send your survey referral link to allow clients to create their own unique survey.<br>
        Any surveys created with this link will be associated with your account.
      </p>

      {% with url=create_survey_url|ng_mark_safe el=engagement_lead|ng_mark_safe %}
        {% include 'public/inc/global/copy-comp.inc.html' with id="referral-link" value=url|add:"#el="|add:el %}
      {% endwith %}
    </li>
  </ul>

  <div
      class="dmb-side-panel dmb-side-panel--narrow dmb-side-panel--right"
      dmb-side-panel
      id="dmb-create-survey">
    <button
        class="dmb-side-panel__fab dmb-fab"
        dmb-side-panel-close>
      <span class="dmb-fab__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <use xlink:href="#mi-close"></use>
        </svg>
      </span>
    </button>

    <div
        class="dmb-side-panel__inner"
        ng-controller="RegistrationCtrl as registrationCtrl">
      <div ng-if="!registrationCtrl.link">
        <h2 class="h-c-headline h-c-headline--three h-u-mt-xl h-u-mb-l">
          Create a new survey
        </h2>
        <p>
          Fill in these details to create a custom survey link for a specific company:
        </p>
        <form
            autocomplete="off"
            class="dmb-form"
            name="registration"
            ng-init="registrationCtrl.engagementLead='{{engagement_lead|ng_mark_safe}}'"
            ng-submit="registrationCtrl.submit()"
            novalidate>
          <div class="dmb-form__wrapper">

            <div class="dmb-input-wrp">
              <input
                  class="dmb-input"
                  id="tenant"
                  name="tenant"
                  ng-init="registrationCtrl.tenant='{{tenant|ng_mark_safe}}'"
                  ng-model="registrationCtrl.tenant"
                  required
                  type="hidden"
                  value="{{tenant|ng_mark_safe}}">
            </div>

            <div class="dmb-input-wrp">
              <input
                  class="dmb-form__input"
                  name="companyName"
                  ng-model="registrationCtrl.companyName"
                  placeholder="{% if tenant|ng_mark_safe == 'ads' %}Organisation {% else %}Organization {% endif %}name:"
                  required
                  type="text">
            </div>

            <div class="dmb-input-wrp">
              {% if tenant|ng_mark_safe == 'ads' %}
                <select
                    class="dmb-form__select"
                    id="industry"
                    name="industry"
                    ng-model="registrationCtrl.industry"
                    required>
                  <option
                      disabled
                      selected
                      value="">
                    Select an industry
                  </option>
                  {% for i_key, i_text in industries %}
                    <option value="{{ i_key|ng_mark_safe }}">
                      {{i_text|ng_mark_safe}}
                    </option>
                  {% endfor %}
                </select>
              {% endif %}

              {% if tenant|ng_mark_safe == 'news' %}
                {% comment %} TODO: use news industry here {% endcomment %}
                <input
                    id="prodId"
                    name="industry"
                    type="hidden"
                    ng-init="registrationCtrl.industry='ic-bnpj'"
                    value="ic-bnpj">
              {% endif %}

              {% if tenant|ng_mark_safe == 'retail' %}
                <input
                    id="prodId"
                    name="industry"
                    ng-init="registrationCtrl.industry='rt-o'"
                    type="hidden"
                    value="rt-o">
              {% endif %}
            </div>

            <div class="dmb-input-wrp">
              <select
                  class="dmb-form__select"
                  id="country"
                  name="country"
                  ng-model="registrationCtrl.country"
                  required>
                <option
                    disabled
                    selected
                    value="">
                  Select a country
                </option>
                {% for c_key, c_text in countries %}
                <option value="{{c_key|ng_mark_safe}}">
                  {{c_text|ng_mark_safe}}
                </option>
                {% endfor %}
              </select>
            </div>

            <div
                class="dmb-form__error"
                ng-show="!registration.companyName.$pristine && registration.companyName.$error.required">
              This field is required.
            </div>

          </div>

          <button
              class="dmb-form__submit h-c-button h-c-button--primary"
              ng-disabled="!registration.$valid">
            Create assessment
          </button>

          <div
              class="dmb-form__error"
              ng-hide="!registrationCtrl.serverError">
            Oops, something went wrong!
          </div>

        </form>
      </div>

      <div ng-if="registrationCtrl.link">
        <h2 class="h-c-headline h-c-headline--three h-c-headline--three h-u-mt-xl h-u-mb-l">
          Unique survey created
        </h2>
        <p>
          Your custom survey link is below. Send this link to your client so that they can get started.
        </p>

        {% include 'public/inc/global/copy-comp.inc.html' with id="survey-link" value='{[ registrationCtrl.link ]}' %}

        <button class="h-c-button h-c-button--primary" ng-click="registrationCtrl.reset()">
          Create another assessment
        </button>
        <p class="h-c-footnote">
          Please reload the page to see the new survey in the list.
        </p>
      </div>
    </div>
  </div>

  <div class="dmb-reports-admin__table dmb-table h-c-table__overflowcontainer">
    <table
        class="h-c-table h-c-table--datatable h-c-table--datatable-altrows glue-table-sort"
        data-glue-table-sort-ascending-text="ascending"
        data-glue-table-sort-descending-text="descending"
        data-glue-table-sort-unsorted-text="unsorted"
        role="table"
        summary="List of reports"
        width="100%">
      <thead>
        <tr role="row">
          <th
              class="dmb-table__ellipsis-col"
              data-glue-table-sort-type="alpha"
              role="columnheader"
              scope="col"
              title="Sort by {% if tenant|ng_mark_safe == 'ads' %}organisation{% else %}organization{% endif %} name alphabetically">
            <span>
              {% if tenant|ng_mark_safe == 'ads' %}Organisation{% else %}Organization{% endif %} name
            </span>
          </th>
          <th
              data-glue-table-sort-type="datetime-custom"
              role="columnheader"
              scope="col"
              title="Sort by date created chronologically">
            <span>
              Date created
            </span>
          </th>
          <th
              data-glue-table-sort-type="numeric"
              role="columnheader"
              scope="col"
              title="Sort by survey completions numerically">
            <span>
              Survey completions
            </span>
          </th>
          <th
              data-glue-table-sort-type="alpha"
              role="columnheader"
              scope="col"
              title="Sort by survey link">
            <span>
              Survey links
            </span>
          </th>
          <th
              data-glue-table-sort-type="alpha"
              role="columnheader"
              scope="col"
              title="Sort by report link">
            <span>
              Report links
            </span>
          </th>
          <th
              data-glue-table-sort-type="alpha"
              role="columnheader"
              scope="col"
              title="Sort by country">
            <span>
              Details
            </span>
          </th>
          <th
              class="dmb-table__ellipsis-col dmb-table__ellipsis-col-long"
              data-glue-table-sort-type="alpha"
              role="columnheader"
              scope="col"
              title="Sort by industry">
            <span>
              Industry
            </span>
          </th>
          <th
              data-glue-table-sort-type="alpha"
              role="columnheader"
              scope="col"
              title="Sort by country">
            <span>
              Country
            </span>
         </th>
        </tr>
      </thead>
      <tbody>
        <tr
            data-index={[$index]}
            ng-class="{'dmb-table__expanded-row': reportAdminCtrl.expandedRows[$index]}"
            ng-repeat="survey in reportAdminCtrl.surveys"
            role="row">
          <td
              class="dmb-table__ellipsis-col"
              role="rowheader"
              title="{[survey.company_name]}">
            {[survey.company_name]}
          </td>
          <td
              ng-attr-title="{[survey.created_at|date:'d/M/yyyy hh:mm']}"
              role="gridcell">
            {[survey.created_at|date:"d/M/yyyy"]}
            {% comment %} This is used by tablesort-utility.js module to sort by date, please update it if this changes {% endcomment %}
            <span class="dmb-table__utc-date">
              utc={[survey.created_at]}
            </span>
          </td>
          <td role="gridcell">
            {[ survey.survey_results.length ]}
            <button
                class="dmb-table__expand-row-btn"
                ng-click="reportAdminCtrl.viewHistory($index)"
                ng-if="survey.survey_results.length > 1">
              View history
              <svg role="img" class="h-c-icon">
                <use xlink:href="#mi-chevron"></use>
              </svg>
            </button>
            <div
                class="dmb-table__subcell dmb-table__subcell--first"
                ng-repeat="r in survey.survey_results">
              {[r.started_at|date:"d/M/yyyy hh:mm"]}
            </div>
          </td>
          <td role="gridcell">
            <a
                class="h-c-button h-c-button--flat"
                href="{[survey.link]}"
                target="_blank">
              Survey
            </a>
          </td>
          <td role="gridcell">
            <a
                class="dmb-table__top-cell h-c-button h-c-button--flat"
                ng-if="survey.survey_results.length > 0"
                ng-href="{[survey.last_survey_result_link]}"
                target="_blank">
              Report
            </a>&nbsp;
            <span ng-if="survey.survey_results.length == 0">
              -
            </span>
            <div
                class="dmb-table__subcell"
                ng-repeat="r in survey.survey_results">
              <a
                  class="h-c-button h-c-button--flat"
                  ng-href="{[r.report_link]}"
                  target="_blank">
                Report
              </a>
            </div>
          </td>
          <td role="gridcell">
            <a
                class="dmb-table__top-cell h-c-button h-c-button--flat"
                ng-href="{[survey.last_survey_result.detail_link]}"
                ng-if="survey.last_survey_result.detail_link"
                target="_blank">
              Details
            </a>&nbsp;
            <span ng-if="!survey.last_survey_result.detail_link">
              -
            </span>
            <div
                class="dmb-table__subcell"
                ng-repeat="r in survey.survey_results">
              <a
                  class="h-c-button h-c-button--flat"
                  ng-href="{[r.detail_link]}"
                  ng-if="r.detail_link"
                  target="_blank">
                Details
              </a>
              <span ng-if="!r.detail_link">
                -
              </span>
            </div>
          </td>
          <td
              class="dmb-table__ellipsis-col dmb-table__ellipsis-col--long"
              ng-attr-title="{[survey.industry_name]}"
              role="gridcell">
            {[survey.industry_name]}
          </td>
          <td role="gridcell">
            {[survey.country_name]}
          </td>
        </tr>
      </tbody>
    </table>

    <div class="glue-js-table__caption"></div>

  </div>
</div>
{% endblock %}
